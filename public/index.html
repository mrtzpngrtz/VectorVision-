<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageVector - Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=dual_sidebar">
</head>
<body>
    <div id="app">
        <!-- LEFT SIDEBAR (Navigation & View) -->
        <div id="sidebar-left" class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">VECTOR VISION</h1>
            </div>

            <div class="sidebar-scroll-area">
                <!-- LIBRARIES -->
                <div class="sidebar-section">
                    <div class="section-label" onclick="toggleSidebarSection('libraries-content')">
                        LIBRARIES <span class="chevron">▼</span>
                    </div>
                    <div id="libraries-content" class="section-content">
                        <div id="current-library-display"></div>
                        <button onclick="showLibrarySelection()" class="primary-btn compact">Open Library</button>
                    </div>
                </div>

                <!-- DISPLAY -->
                <div class="sidebar-section">
                    <div class="section-label">DISPLAY MODE</div>
                    <div class="section-content">
                        <div class="radio-group-vertical">
                            <button onclick="setViewMode(false)" id="view-2d" class="radio-btn active">2D Flat View</button>
                            <button onclick="setViewMode(true)" id="view-3d" class="radio-btn">3D Space View</button>
                        </div>
                        
                        <div id="view-presets" style="display:none;">
                            <button id="auto-move-toggle" onclick="toggleAutoMove()" class="secondary-btn compact" style="width:100%">Auto Drift: ON</button>
                        </div>
                    </div>
                </div>

                <!-- SORT -->
                <div class="sidebar-section">
                    <div class="section-label">SORTING</div>
                    <div class="section-content">
                        <div class="radio-group-vertical">
                            <button onclick="setSorting('semantic')" id="sort-semantic" class="radio-btn active">Semantic (AI)</button>
                            <button onclick="setSorting('color')" id="sort-color" class="radio-btn">Color Spectrum</button>
                            <button onclick="setSorting('lightness')" id="sort-lightness" class="radio-btn">Lightness</button>
                            <button onclick="setSorting('grid')" id="sort-grid" class="radio-btn">Grid (Date)</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button onclick="openHelp()" class="secondary-btn" style="width: 100%; justify-content: center; display: flex;">Help & About</button>
            </div>
        </div>

        <!-- MAIN VIEW -->
        <div id="main">
            
            <div id="map-container"></div>
            
            <div id="active-tag-display">
                <span id="active-tag-text"></span>
                <div id="active-tag-close" onclick="clearAll()">✕</div>
            </div>
            
            <div id="fps-counter">FPS: --</div>
            <div id="zoom-info">100%</div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" style="display: none;">
                <div class="loading-content">
                    <div class="loader"></div>
                    <div id="status" class="status-text">Ready</div>
                    <div id="status-description" class="status-description">Preparing to process images...</div>
                    <div id="status-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-details">
                            <div class="progress-text" id="progress-percentage">0%</div>
                            <div class="stats-compact">
                                <span id="stat-processed">0</span> / <span id="stat-total">0</span> 
                                <span class="stat-separator">|</span>
                                <span id="stat-speed">0/s</span>
                                <span class="stat-separator">|</span>
                                <span>ETA: <span id="stat-eta">--</span></span>
                            </div>
                        </div>
                    </div>
                    <div id="detected-tags" class="detected-tags"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR (Inspector) -->
        <div id="sidebar-right" class="sidebar">
            <div class="sidebar-header">
                <div class="section-label" style="margin:0; opacity: 1;">INSPECTOR</div>
            </div>

            <!-- PREVIEW -->
            <div class="sidebar-section">
                <div class="section-label">PREVIEW</div>
                <div id="preview-container">
                    <img id="preview-img" style="max-width: 100%; max-height: 100%; display: none; object-fit: contain;">
                    <span id="preview-placeholder" style="opacity: 0.3; font-size: 0.7rem; font-family: monospace;">Hover image</span>
                </div>
            </div>

            <!-- INFO -->
            <div class="sidebar-section">
                <div class="section-label">INFO</div>
                <div id="semantic-info" class="info-content">Hover over an image to see details...</div>
            </div>

            <div class="sidebar-scroll-area">
                <!-- FILTER -->
                <div class="sidebar-section" style="border-bottom: none;">
                    <div class="section-label">SEARCH & FILTER</div>
                    <div class="section-content">
                        <div class="input-group">
                            <input type="text" id="search-input" placeholder="Search tags...">
                            <button onclick="searchImages()" class="icon-btn">→</button>
                            <button onclick="clearAll()" class="icon-btn">✕</button>
                        </div>
                        
                        <div id="color-filter-section" style="margin-top: 10px; display: none;">
                            <div class="section-label" style="font-size: 0.7rem; opacity: 0.6; margin-bottom: 5px;">TOP COLORS</div>
                            <div id="color-palette" class="palette-container" style="flex-wrap: wrap;"></div>
                        </div>

                        <div id="library-wordcloud-section" style="padding: 0; border: none; margin-top: 10px;">
                            <div id="library-wordcloud" class="library-wordcloud"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Lightbox -->
    <button id="bottom-ui-toggle" onclick="toggleUI()">HIDE UI</button>

    <div id="lightbox">
        <img id="lightbox-img">
        <div class="lightbox-controls">
            <button class="lightbox-btn" onclick="copyLightboxImage()" title="Copy to Clipboard">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
            <button class="lightbox-btn" onclick="saveLightboxImage()" title="Save Image">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="lightbox-btn" onclick="openLightboxFolder()" title="Open in Folder">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
            </button>
        </div>
        <div class="lightbox-close" onclick="document.getElementById('lightbox').style.display='none'">&times;</div>
    </div>

    <!-- Library Name Modal -->
    <div id="library-modal" style="display: none;">
        <div class="modal-content">
            <h3>Library Name</h3>
            <input type="text" id="library-name-input" placeholder="Enter library name...">
            <div class="modal-buttons">
                <button onclick="confirmLibraryName()" class="primary-btn">Save</button>
                <button onclick="cancelLibraryName()" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Library Selection Modal (Startup) -->
    <div id="library-selection-modal" style="display: none;">
        <div class="modal-content selection-modal-content">
            <h3>Select Library</h3>
            <div class="selection-scroll-area">
                <div id="selection-libraries-list" class="selection-list">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-buttons vertical-buttons">
                <button id="load-library-btn" onclick="loadSelectedLibrary()" class="primary-btn" disabled>LOAD LIBRARY</button>
                <button onclick="createNewLibrary(true)" class="secondary-btn">Add / Create Library</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Dialog -->
    <div id="confirm-modal" style="display: none;">
        <div class="modal-content confirm-modal">
            <h3 id="confirm-title">Confirm Action</h3>
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-ok-btn" class="primary-btn">OK</button>
                <button id="confirm-cancel-btn" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Start Popup -->
    <div id="start-popup" style="display: none;">
        <div class="modal-content start-popup-content">
            <h3>Welcome to VectorVision</h3>
            <div class="start-popup-body" style="max-height: 70vh; overflow-y: auto;">
                <p class="intro-text">VectorVision is a high-performance desktop application that organizes images using AI to find visual similarities and semantic relationships.</p>
                
                <div class="popup-columns">
                    <div class="popup-column">
                        <h4>Core Features</h4>
                        <ul class="feature-list">
                            <li><strong>AI Semantic Clustering</strong> – Organizes images by visual similarity using CLIP embeddings and Self-Organizing Maps</li>
                            <li><strong>GPU-Accelerated Analysis</strong> – Native DirectML (Windows) or CoreML (macOS) for 5-10x faster processing</li>
                            <li><strong>Multi-Dimensional Sorting</strong> – View by semantic similarity, color spectrum, lightness, or grid</li>
                            <li><strong>150+ Smart Categories</strong> – Zero-shot classification optimized for artistic/design/fashion photography</li>
                            <li><strong>Semantic Search</strong> – Filter by keywords with automatic re-clustering of results</li>
                            <li><strong>100% Private</strong> – All AI analysis happens locally on your machine, no cloud or API keys required</li>
                        </ul>
                    </div>
                    
                    <div class="popup-column">
                        <h4>Controls</h4>
                        <div class="controls-grid">
                            <div class="control-row">
                                <span class="control-key">Left Drag</span>
                                <span class="control-desc">Pan View</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">Scroll</span>
                                <span class="control-desc">Zoom</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">Click</span>
                                <span class="control-desc">Focus Image</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">Dbl Click</span>
                                <span class="control-desc">Lightbox</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">Shift+Hover</span>
                                <span class="control-desc">Show Similar</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">Space</span>
                                <span class="control-desc">Quick View</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">ESC</span>
                                <span class="control-desc">Clear Filters</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="popup-section">
                    <h4>Technology Stack</h4>
                    <div class="tech-grid">
                        <div class="tech-item">
                            <strong>Electron 28</strong>
                            <span>Cross-platform desktop framework</span>
                        </div>
                        <div class="tech-item">
                            <strong>ONNX Runtime</strong>
                            <span>Native AI inference with DirectML/CoreML GPU support</span>
                        </div>
                        <div class="tech-item">
                            <strong>CLIP (ViT-Base-Patch32)</strong>
                            <span>OpenAI's vision-language model for image embeddings & zero-shot classification</span>
                        </div>
                        <div class="tech-item">
                            <strong>Self-Organizing Maps</strong>
                            <span>Unsupervised clustering algorithm for spatial layout in 2D/3D</span>
                        </div>
                        <div class="tech-item">
                            <strong>Sharp</strong>
                            <span>High-performance Node.js image processing for thumbnails</span>
                        </div>
                        <div class="tech-item">
                            <strong>Canvas Renderer</strong>
                            <span>Custom WebGL-free rendering with viewport culling for 10,000+ images</span>
                        </div>
                    </div>
                </div>

                <div class="popup-section">
                    <h4>How It Works</h4>
                    <div class="function-list">
                        <div class="function-item">
                            <strong>1. Image Analysis</strong>
                            <p>Each image is processed through the CLIP vision model to extract a 512-dimensional feature vector representing its visual content. Simultaneously, color analysis extracts dominant colors and palettes.</p>
                        </div>
                        <div class="function-item">
                            <strong>2. Zero-Shot Classification</strong>
                            <p>Images are classified against 150+ predefined categories (e.g., "monochrome", "geometric pattern", "fashion") without training, using CLIP's language-vision alignment.</p>
                        </div>
                        <div class="function-item">
                            <strong>3. Semantic Clustering</strong>
                            <p>Self-Organizing Maps train on the feature vectors to arrange images spatially—similar images cluster together in 2D grids or 3D space, creating an explorable semantic landscape.</p>
                        </div>
                        <div class="function-item">
                            <strong>4. Persistent Caching</strong>
                            <p>Analysis results are cached per library for instant loading. Models (~600MB) are downloaded once and reused across sessions.</p>
                        </div>
                        <div class="function-item">
                            <strong>5. Real-Time Filtering</strong>
                            <p>Search queries trigger re-clustering of matched images, maintaining semantic relationships within filtered results.</p>
                        </div>
                    </div>
                </div>
                
                <div class="popup-meta">
                    <p class="small-text">All analysis happens locally using your GPU. No cloud, no tracking, no API keys.</p>
                    <p class="meta-info">
                        Version Alpha 0.9 • Created by Moritz Pongratz<br>
                        <a href="#" onclick="window.electronAPI.openExternal('https://aop.studio')">aop.studio</a> • 
                        <a href="#" onclick="window.electronAPI.openExternal('https://github.com/mrtzpngrtz/VectorVision')">GitHub</a>
                    </p>
                    <p class="disclaimer">Experimental Software • GPU Heavy • Requires DirectX 12 (Windows) or Metal (macOS)</p>
                </div>
            </div>
            <div class="start-popup-footer">
                <label class="checkbox-container">
                    <input type="checkbox" id="dont-show-again">
                    <span class="checkmark"></span>
                    Don't show this again
                </label>
                <button onclick="closeStartPopup()" class="primary-btn">Get Started</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
